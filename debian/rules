#!/usr/bin/make -f

derives_from_ubuntu := $(shell (dpkg-vendor --derives-from Ubuntu && echo "yes") || echo "no")

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
else
	# Faster when testing on modern desktops, 1 task takes less than a full CPU
	NUMJOBS = 4
endif

%:
	dh $@ --with autoreconf --with pyppd --parallel

override_dh_auto_clean:
	dh_auto_clean
	rm -rf foomatic-db

override_dh_auto_install:
	dh_auto_install
	rm -rf debian/ptouch-driver/usr/share/foomatic/db/source/printer

	# Pre-build PPD files
	mkdir $(CURDIR)/foomatic-db
	cp -r /usr/share/foomatic/* $(CURDIR)/foomatic-db
	rm -f $(CURDIR)/foomatic-db/db/source/*/*ptouch*.xml
	cp -r $(CURDIR)/debian/ptouch-driver/usr/share/foomatic/* $(CURDIR)/foomatic-db/
	rm -rf $(CURDIR)/debian/ptouch-driver/usr/share/foomatic
	mkdir -p $(CURDIR)/debian/ptouch-driver/usr/share/ppd
	FOOMATICDB=$(CURDIR)/foomatic-db foomatic-compiledb -j $(NUMJOBS) -t ppd -d $(CURDIR)/debian/ptouch-driver/usr/share/ppd/ptouch-driver `ls -1 $(CURDIR)/foomatic-db/db/source/driver/*ptouch*.xml | perl -p -e 's:^.*db/source/driver/(\S*)\.xml\s*$$:\1\n:'`

        # Install the ppd updater data file so that CUPS can update the
        # PPDs of the already existing queues after each update of the 
        # ptouch-driver package
	install -D -m 644 debian/ptouch-driver.ppd-updater $(CURDIR)/debian/ptouch-driver/usr/share/cups/ppd-updaters/ptouch-driver

ifeq ($(derives_from_ubuntu),yes)
        # Install Apport hook
	install -D -m 644 debian/local/apport-hook.py $(CURDIR)/debian/ptouch-driver/usr/share/apport/package-hooks/source_ptouch-driver.py
endif
